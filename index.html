<!DOCTYPE html>
<html>
<head>
    <style>
        body { margin: 0; width: 100vw; height: 100vh; }
        #3d-graph { width: 100%; height: 100%; }
    </style>
</head>
<body>
    <div id="3d-graph"></div>
    <script type="module">
        import * as THREE from './libs/three.module.js';
        window.THREE = THREE;
        import { gData } from './data.js';

        // const gData = {
        //     "nodes": [
        //       { "id": 0, "img": "./output/images_test/cat.png" },
        //       { "id": 1, "img": "./output/images_test/dog.png" },
        //       { "id": 2, "img": "./output/images_test/eagle.png" }
        //     ],
        //     "links": [
        //       { "source": 0, "target": 1 },
        //       { "source": 0, "target": 2 },
        //       { "source": 1, "target": 2 }
        //     ]
        // };

        function initGraph() {
            const distance = 900;
            const nodeSize = 400; 
            
            const Graph = ForceGraph3D()(document.getElementById('3d-graph'))
            .nodeThreeObject(node => {
                    const group = new THREE.Group(); // สร้างกลุ่มสำหรับรวมทั้งรูปภาพและ label

                    // รูปภาพ
                    const img = new Image();
                    img.src = `${node.img}`;
                    const canvas = document.createElement('canvas');
                    canvas.width = 60; // ขนาดของรูปภาพ
                    canvas.height = 60;
                    const ctx = canvas.getContext('2d');

                    img.onload = () => {
                        ctx.drawImage(img, 0, 0, 60, 60);
                        sprite.material.map.needsUpdate = true; // อัปเดต texture
                    };

                    img.onerror = () => {
                        console.error('Failed to load image for node:', node.id);
                    };

                    const texture = new THREE.CanvasTexture(canvas);
                    const material = new THREE.SpriteMaterial({ map: texture });
                    const sprite = new THREE.Sprite(material);
                    sprite.scale.set(30, 30, 1); // ขนาดของ sprite (ครึ่งหนึ่งของ canvas)

                    group.add(sprite); // เพิ่มรูปภาพเข้าไปในกลุ่ม

                    // Label (ข้อความใต้รูปภาพ)
                    const labelCanvas = document.createElement('canvas');
                    labelCanvas.width = 128;
                    labelCanvas.height = 32;
                    const labelCtx = labelCanvas.getContext('2d');
                    labelCtx.font = '16px Arial';
                    labelCtx.fillStyle = 'white';
                    labelCtx.textAlign = 'center';
                    labelCtx.fillText(node.id, labelCanvas.width / 2, labelCanvas.height / 2);

                    const labelTexture = new THREE.CanvasTexture(labelCanvas);
                    const labelMaterial = new THREE.SpriteMaterial({ map: labelTexture });
                    const labelSprite = new THREE.Sprite(labelMaterial);
                    // labelSprite.position.set(0, -20, 0); // วาง label ใต้รูปภาพ
                    // labelSprite.scale.set(40, 10, 1); // ปรับขนาด label

                    group.add(labelSprite); 

                    return group;
                })

                .enableNodeDrag(true)
                .enableNavigationControls(true)
                .showNavInfo(true)
                .cameraPosition({ z: distance })
                .linkDirectionalParticles(2)
                .linkDirectionalParticleWidth(1)
                .linkDirectionalArrowLength(0)
                .linkDirectionalArrowRelPos(0)
                .linkWidth(2)
                .onNodeClick(node => {
                const focusDistance = 250; // ระยะห่างจากโหนด
                const distRatio = 1 + focusDistance / Math.hypot(node.x, node.y, node.z);
                const newCameraPos = node.x || node.y || node.z
                ? { x: node.x * distRatio, y: node.y * distRatio, z: node.z * distRatio }
                : { x: 0, y: 0, z: focusDistance }; // กรณีพิเศษถ้าโหนดอยู่ที่ (0,0,0)
                Graph.cameraPosition(
                    newCameraPos, // ตำแหน่งใหม่
                    node, // โฟกัสไปยังโหนด
                    3000 // ระยะเวลาในการเปลี่ยนตำแหน่ง (ms)
                );
            })
                .graphData(gData);

            // let angle = 0;
            // setInterval(() => {
            //     Graph.cameraPosition({
            //         x: distance * Math.sin(angle),
            //         z: distance * Math.cos(angle)
            //     });
            //     angle += Math.PI / 300;
            // }, 10);
        }

        window.addEventListener('load', initGraph);
    </script>
    <script src="./libs/3d-force-graph.min.js"></script>
</body>
</html>